<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LiPa – Events</title>
  <link rel="stylesheet" href="Style.css" />
</head>

<body class="page--events">
  <header id="HeadBar"></header>

  <main class="page">
    <section class="pageHero">
      <div class="container pageHero__inner">
        <h1 class="pageHero__title">Events</h1>
        <p class="pageHero__subtitle">Alle Termine unserer Partner-Bands – als klare Agenda, ohne Google-Kalender-Chaos.</p>
      </div>
    </section>

    <section class="section container">
      <div class="eventsShell">
        <div class="eventsTop">
          <div class="eventsTop__left">
            <div class="eventsTop__kicker">Agenda</div>
            <div class="eventsTop__title">Termine &amp; Gigs</div>
            <div class="eventsTop__hint" id="eventsHint">Lade Events…</div>
          </div>

          <div class="eventsTop__right">
            <div class="chipRow" id="tagChips">
              <button class="chip is-active" type="button" data-tag="">Alle</button>
            </div>

            <label class="toggle">
              <input type="checkbox" id="onlyUpcoming" checked />
              <span class="toggle__ui" aria-hidden="true"></span>
              <span class="toggle__label">Nur kommende</span>
            </label>
          </div>
        </div>

        <div class="eventsList" id="eventsList" aria-label="Event Liste">
          <div class="eventsEmpty" id="eventsEmpty">Lade Events…</div>
        </div>

        <div class="eventsBottom">
          <button class="btn btn--ghost eventsMore" type="button" id="loadMoreBtn">Mehr laden</button>
        </div>
      </div>
    </section>
  </main>

  <div id="FootBar"></div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    $(function () {
      $("#HeadBar").load("FixedPages/HeadBar.html", function () {
        const topbar = document.querySelector(".topbar");
        const burger = document.querySelector("[data-burger]");
        if (topbar && burger) {
          burger.addEventListener("click", () => {
            const open = topbar.classList.toggle("is-open");
            burger.setAttribute("aria-expanded", String(open));
          });
          document.addEventListener("click", (e) => {
            if (!topbar.classList.contains("is-open")) return;
            if (topbar.contains(e.target)) return;
            topbar.classList.remove("is-open");
            burger.setAttribute("aria-expanded", "false");
          });
        }
      });
      $("#FootBar").load("FixedPages/FootBar.html");
    });
  </script>

  <script>
    /* =========================
       CONFIG
       ========================= */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwggY3Wc_iQZ58jdb5I83gZguXYLagXmUA7nD89wlLAIs3j9ut5Uxu3TWbEM1rvylwNWw/exec";
    const SHEET_ID  = "1oFEXMdaS3tfXsILJPayhCyz8SDltD82l0dFll1ZlFOA";
    const SHEET_TAB = "Tabellenblatt1"; // oder wie dein Tab wirklich heißt


    /* =========================
       STATE
       ========================= */
    let ALL_EVENTS = [];
    let FILTER_TAG = "";
    let SHOW_UPCOMING_ONLY = true;
    let RENDER_LIMIT = 12;

    /* =========================
       JSONP loader
       ========================= */
    function loadJsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const s = document.createElement("script");
        const t = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 12000);

        function cleanup(){
          clearTimeout(t);
          delete window[cb];
          s.remove();
        }

        window[cb] = (data) => { cleanup(); resolve(data); };
        s.onerror = () => { cleanup(); reject(new Error("jsonp failed")); };

        const sep = url.includes("?") ? "&" : "?";
        s.src = url + sep + "callback=" + cb;
        document.head.appendChild(s);
      });
    }

    async function fetchEvents(){
      const url =
        `${WEB_APP_URL}?sheetId=${encodeURIComponent(SHEET_ID)}&tab=${encodeURIComponent(SHEET_TAB)}&status=published&limit=400`;
      const data = await loadJsonp(url);
      if (!data || !data.ok) throw new Error(data && data.error ? data.error : "API error");
      ALL_EVENTS = Array.isArray(data.events) ? data.events : [];
    }

    function initUI(){
      document.getElementById("onlyUpcoming").addEventListener("change", (e) => {
        SHOW_UPCOMING_ONLY = !!e.target.checked;
        RENDER_LIMIT = 12;
        renderAll();
      });

      document.getElementById("loadMoreBtn").addEventListener("click", () => {
        RENDER_LIMIT += 12;
        renderAll();
      });
    }

    function renderAll(){
      renderTags();
      renderList();
      renderHint();
    }

    function renderHint(){
      const hint = document.getElementById("eventsHint");
      const shown = getFiltered().length;
      hint.textContent = `${shown} Event(s) gefunden`;
    }

    function renderTags(){
      const chipRow = document.getElementById("tagChips");
      const tags = uniq(ALL_EVENTS.map(e => (e.tag || "").trim()).filter(Boolean)).sort((a,b)=>a.localeCompare(b));

      chipRow.innerHTML =
        `<button class="chip ${FILTER_TAG==="" ? "is-active":""}" type="button" data-tag="">Alle</button>` +
        tags.map(t => `<button class="chip ${FILTER_TAG===t ? "is-active":""}" type="button" data-tag="${escAttr(t)}">${esc(t)}</button>`).join("");

      chipRow.querySelectorAll(".chip").forEach(btn => {
        btn.addEventListener("click", () => {
          FILTER_TAG = btn.getAttribute("data-tag") || "";
          RENDER_LIMIT = 12;
          renderAll();
        });
      });
    }

    function getFiltered(){
      const today = isoDate(new Date());
      return ALL_EVENTS
        .filter(e => !FILTER_TAG || (e.tag || "") === FILTER_TAG)
        .filter(e => !SHOW_UPCOMING_ONLY || e.date >= today)
        .slice()
        .sort((a,b) => (a.startISO || a.date).localeCompare(b.startISO || b.date));
    }

    function renderList(){
      const list = document.getElementById("eventsList");
      const empty = document.getElementById("eventsEmpty");
      const btnMore = document.getElementById("loadMoreBtn");

      const filtered = getFiltered();
      const slice = filtered.slice(0, RENDER_LIMIT);

      if (!filtered.length){
        list.innerHTML = `<div class="eventsEmpty">Keine Events (noch). Sheet füllen, dann lebt’s.</div>`;
        btnMore.style.display = "none";
        return;
      }

      list.innerHTML = slice.map(renderRow).join("");
      attachRowClicks(list);

      btnMore.style.display = (filtered.length > slice.length) ? "inline-flex" : "none";
    }

    function renderRow(e){
      const time = (e.start && e.end) ? `${e.start}–${e.end}` : (e.start ? e.start : "");
      const meta = [e.band, e.location].filter(Boolean).join(" · ");
      const managed = e.managedBy ? `<span class="badge badge--dark">${esc(e.managedBy)}</span>` : "";
      const tag = e.tag ? `<span class="badge badge--soft">${esc(e.tag)}</span>` : "";
      const urlAttr = e.url ? `data-url="${escAttr(e.url)}"` : "";

      return `
        <article class="eRow" ${urlAttr}>
          <div class="eRow__date">
            <div class="eRow__day">${esc(dayShort(e.date))}</div>
            <div class="eRow__num">${esc(dayNum(e.date))}</div>
            <div class="eRow__mon">${esc(monthShort(e.date))}</div>
          </div>

          <div class="eRow__main">
            <div class="eRow__top">
              <div class="eRow__title">${esc(e.title)}</div>
              <div class="eRow__time">${time ? esc(time) : "—"}</div>
            </div>

            ${meta ? `<div class="eRow__meta">${esc(meta)}</div>` : ``}

            <div class="eRow__pills">
              ${tag}
              ${managed}
              ${e.url ? `<span class="badge badge--link">Link</span>` : ``}
            </div>
          </div>
        </article>
      `;
    }

    function attachRowClicks(container){
      container.querySelectorAll(".eRow[data-url]").forEach(row => {
        row.addEventListener("click", () => {
          const url = row.getAttribute("data-url");
          if (!url) return;
          window.open(url, "_blank", "noopener");
        });
      });
    }

    /* ===== Utilities ===== */
    function isoDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function uniq(arr){ return [...new Set(arr)]; }
    function parseIsoDate(s){
      const [y,m,d] = String(s).split("-").map(n => parseInt(n,10));
      return new Date(y, (m||1)-1, d||1);
    }
    function dayShort(iso){
      const d = parseIsoDate(iso);
      return d.toLocaleDateString("de-DE", { weekday:"short" }).replace(".", "");
    }
    function dayNum(iso){ return String(parseIsoDate(iso).getDate()).padStart(2,"0"); }
    function monthShort(iso){
      const d = parseIsoDate(iso);
      return d.toLocaleDateString("de-DE", { month:"short" }).replace(".", "");
    }
    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function escAttr(s){ return esc(s).replace(/"/g, "&quot;"); }

    /* =========================
       Boot
       ========================= */
    (async function boot(){
      initUI();
      try{
        await fetchEvents();
        renderAll();
      }catch(err){
        console.error(err);
        document.getElementById("eventsList").innerHTML =
          `<div class="eventsEmpty">Fehler beim Laden. Check WEB_APP_URL & SHEET_ID.</div>`;
        document.getElementById("eventsHint").textContent = "Fehler";
        document.getElementById("loadMoreBtn").style.display = "none";
      }
    })();
  </script>

  <!-- Page-local CSS: clean light / matches your current vibe -->
  <style>

  </style>
</body>
</html>
